<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Billy Bassistant</title>
    <link href="../static/css/styles.css" rel="stylesheet">
    <link rel="icon" href="../static/favicon.ico" type="image/x-icon">
</head>
<body class="text-white font-sans">

<!-- üêü Billy Header with Controls & Log Buttons -->
<header class="z-20 p-4 sticky top-0 backdrop-blur-sm shadow-[0_4px_10px_rgba(0,0,0,0.25)]">
    <div class="flex flex-row flex-wrap items-center relative justify-end gap-2 pl-20">
        <div class="flex gap-2 flex-col md:flex-row items-center absolute left-0 group mr-2">
            <img id="status-logo" src="/static/images/status-inactive.png"
                 alt="Billy status"
                 class="w-16 h-16 select-none group-hover:blur-xs transition-all" draggable="false">
            <span id="service-status" class="text-sm font-bold flex opacity-0 group-hover:opacity-100 absolute h-full w-full items-center content-center transition-all">(inactive)</span>
        </div>

        <div id="service-controls" class="flex gap-2 grow justify-end sm:justify-normal">
            <!-- Service buttons inserted via JS -->
        </div>

        <button id="toggle-log-btn"
                class="bg-zinc-700 hover:bg-zinc-600 transition-all text-white text-sm py-1 px-2 rounded flex gap-1.5 items-center cursor-pointer"
                title="Show debug log">
            <span class="material-icons bug_report">bug_report</span>
        </button>

        <button id="toggle-env-btn"
                class="bg-zinc-700 hover:bg-zinc-600 transition-all text-white text-sm py-1 px-2 rounded flex gap-1.5 items-center cursor-pointer"
                title="Show .env file editor">
            <span class="material-icons">admin_panel_settings</span>
        </button>

        <button id="toggle-motion-btn"
                class="bg-zinc-700 hover:bg-zinc-600 transition-all text-white text-sm py-1 px-2 rounded flex gap-1.5 items-center cursor-pointer"
                title="Toggle UI animations">
            <span class="material-icons">blur_on</span>
        </button>

        <div class="relative inline-block">
            <!-- Main power button -->
            <button id="power-btn"
                    class="bg-zinc-700 hover:bg-zinc-600 transition-colors text-white text-sm py-1 px-2 rounded flex gap-1.5 items-center cursor-pointer"
                    title="Power options">
                <span class="material-icons">power_settings_new</span>
            </button>

            <!-- Dropdown -->
            <div id="power-dropdown"
                 class="absolute right-0 mt-2 w-40 bg-zinc-800 border border-zinc-700 rounded shadow-lg hidden z-20">
                <button id="restart-ui-btn"
                        class="w-full flex items-center gap-2 px-3 py-2 text-sm text-white hover:bg-zinc-700 transition-colors">
                    <span class="material-icons text-emerald-400">refresh</span>
                    Restart UI
                </button>
                <button id="reboot-billy-btn"
                        class="w-full flex items-center gap-2 px-3 py-2 text-sm text-white hover:bg-zinc-700 transition-colors">
                    <span class="material-icons text-amber-400">restart_alt</span>
                    Reboot
                </button>
                <button id="shutdown-billy-btn"
                        class="w-full flex items-center gap-2 px-3 py-2 text-sm text-white hover:bg-zinc-700 transition-colors">
                    <span class="material-icons text-rose-400">power_off</span>
                    Shutdown
                </button>
            </div>
        </div>

        <button id="toggle-support-btn"
                class="bg-zinc-700 hover:bg-zinc-600 text-white text-sm py-1 px-2 rounded flex gap-1.5 items-center cursor-pointer"
                title="Show support panel">
            <span class="material-icons">favorite</span>
        </button>

        <div id="version-info" class="text-sm flex flex-col md:items-end relative inline-block">
            <button id="current-version"
                    class="bg-zinc-700 hover:bg-zinc-600 transition-all text-white text-sm py-1 px-2 rounded flex gap-1.5 items-center cursor-pointer"
                    title="Show release notes">
                <span class="material-icons">commit</span>
                <span class="label">Current: ...</span>
            </button>
            <span id="release-badge"
                  class="absolute -top-2 -right-2 inline-flex items-center justify-center w-5 h-5 rounded-full bg-amber-500 hover:bg-amber-400 text-black text-xs font-extrabold shadow">
                  !
            </span>

        </div>

        <div class="flex gap-2 items-center">

            <button id="update-btn"
                    class="hidden bg-amber-500 hover:bg-amber-400 text-zinc-800 text-sm py-1 px-3 rounded gap-1.5 items-center cursor-pointer">
                <span class="material-icons align-middle">system_update_alt</span>
                <span id="latest-version"></span>
            </button>
        </div>
    </div>

    <!-- Log Panel -->
    <section id="log-panel" class="mt-2 relative hidden">
        <!-- Normal Log View -->
        <div id="log-container"
             class="relative rounded px-2 max-h-96 overflow-y-scroll text-sm transition-all duration-300 border border-cyan-500 bg-zinc-800/80 ">

            <!-- Fullscreen Button (top right) -->
            <button id="toggle-fullscreen-btn"
                    class="sticky top-2 left-full mr-3 bg-zinc-800 hover:bg-zinc-700 text-white px-2 py-1 rounded z-10 shadow flex items-center justify-center"
                    title="Toggle Fullscreen Log">
                <span class="material-icons" id="fullscreen-icon">fullscreen</span>
            </button>

            <pre id="log-output"
                 class="text-cyan-500  whitespace-pre-wrap break-words overflow-x-hidden max-w-full">Loading logs‚Ä¶</pre>

            <!-- Scroll-to-bottom Button (bottom right) -->
            <button id="scroll-bottom-btn"
                    title="Auto-scroll"
                    class="sticky bottom-2 left-full mr-3 ml-auto bg-zinc-800 hover:bg-zinc-700 text-white px-2 py-1 rounded z-10 shadow flex items-center justify-center cursor-pointer">
                <span class="material-icons">arrow_downward</span>
            </button>
        </div>
    </section>

    <!-- Env Panel -->
    <section id="env-panel" class="mt-2 relative hidden">
        <div class="relative rounded  text-sm transition-all duration-300  text-white">
            <textarea id="env-textarea" rows="25"
                      class="w-full h-64  bg-zinc-800/80 text-amber-500 p-3 rounded font-mono resize-y border border-yellow-600"
                      spellcheck="false">Loading .env‚Ä¶</textarea>

            <!-- Save button -->
            <div class="mt-2 flex justify-end gap-2">
                <div class=" bg-yellow-700/80 text-yellow-100 p-2 rounded border border-yellow-600 flex grow gap-2 items-center">
                    <span class="material-icons">warning</span>
                    Changes will be written to .env as-is. Invalid values could cause errors. Save only if you‚Äôre sure
                    of your changes.
                </div>

                <button id="save-env-btn"
                        class="bg-amber-500 hover:bg-amber-400 text-zinc-800 text-sm font-semibold  py-1 px-4 rounded shadow">
                    Save .env
                </button>
            </div>
        </div>
    </section>

    <!-- Support Panel -->
    <section id="support-panel" class="mt-2 relative hidden">
        <div class="relative rounded text-sm transition-all duration-300 text-white">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-zinc-800/80 p-4 rounded border border-red-600">

                <!-- Left column: QR + button -->
                <div class="flex flex-col items-center justify-center space-y-4">
                    <img src="../static/images/qrcode.png"
                         alt="PayPal QR code"
                         class="w-40 h-40 object-contain select-none"
                         draggable="false">

                    <a href="https://paypal.me/thomkoopman050"
                       target="_blank"
                       rel="noopener"
                       class="w-auto inline-flex items-center justify-center gap-2 bg-red-500 hover:bg-red-400 text-zinc-900 font-semibold py-1 px-2 rounded shadow">
                        <span class="material-icons">open_in_new</span>
                        <span>Open PayPal.me</span>
                    </a>
                </div>

                <!-- Right column: text -->
                <div class="flex flex-col justify-center text-center md:text-left space-y-2">
                    <p class="text-base text-zinc-200 font-medium">
                        Billy‚Äôs software is provided free of charge and it‚Äôll stay that way.
                    </p>
                    <p class="text-sm text-zinc-400">
                        I build and maintain it in my spare time for fun.<br>
                        If you enjoy Billy and like to support ongoing development, consider a small donation.<br>
                        It's always much appreciated, never required.
                    </p>
                    <p class="text-sm text-zinc-400">
                        Thanks,<br>
                        Thom Koopman
                    </p>
                </div>
            </div>
        </div>
    </section>

    <!-- Release Notes Panel -->
    <section id="release-panel" class="mt-2 relative hidden">
        <div class="relative rounded text-sm transition-all duration-300 text-white">
            <div class="bg-zinc-800/80 p-4 rounded border border-emerald-600">
                <div class="flex items-start gap-3">
                    <span class="material-icons text-emerald-400 select-none" aria-hidden="true">campaign</span>
                    <div class="flex-1">
                        <div class="flex items-center justify-between">
                            <h4 id="release-title" class="text-sm font-bold text-emerald-300">Release Notes</h4>
                            <div class="flex gap-2">
                                <button id="release-mark-read"
                                        class="text-emerald-300 hover:text-emerald-200 text-sm underline underline-offset-4"
                                        title="Mark as read (hide badge)">
                                    Mark as read
                                </button>
                            </div>
                        </div>

                        <!-- Markdown body -->
                        <div id="release-body" class="mt-2 text-sm text-emerald-100 prose prose-invert max-w-none">
                            Loading release notes‚Ä¶
                        </div>

                        <a id="release-link"
                           href="#"
                           target="_blank"
                           rel="noopener"
                           class="hidden inline-flex items-center gap-1 text-emerald-300 hover:text-emerald-200 mt-3">
                            <span class="material-icons text-xs" aria-hidden="true">open_in_new</span>
                            <span class="underline">View on GitHub</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="notification"
         class="hidden w-full fixed top-0 left-0 text-center backdrop-blur-xs text-white font-semibold py-2 px-4 rounded shadow-lg z-50 transition-opacity duration-300"></div>

</header>

<!-- Section 2‚Äì4 in responsive grid layout -->
<main id="main-content" class="max-w-6xl mx-auto">
    <div class="grid grid-cols-1 md:grid-cols-2 ">
        <!-- Settings Form -->
        <section>
            <form id="config-form" class="p-4 md:p-6">

                <!-- Software Settings -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-software">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Software Settings
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>

                    <div class="mb-4 relative">
                        <label for="OPENAI_API_KEY"
                               class="flex justify-between items-center font-semibold text-sm text-slate-300 relative">
                            OpenAI API Key
                            <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                  onclick="toggleTooltip(this)">
                                help_outline
                            </span>
                        </label>
                        <div class="relative">
                            <div data-tooltip>
                                You need a <a href="https://platform.openai.com/account/api-keys"
                                              class="underline hover:text-cyan-400" target="_blank">secret API key</a>
                                with an available credit. In the <a
                                    href="https://platform.openai.com/account/billing/overview"
                                    class="underline hover:text-cyan-400" target="_blank">billing panel</a>, add a
                                payment method (under Payment Methods). After adding a payment method, add credits to
                                your organization by clicking 'Buy credits'.
                            </div>
                            <input
                                    type="password"
                                    class="w-full p-3 mt-1 pr-10 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    id="OPENAI_API_KEY"
                                    name="OPENAI_API_KEY"
                                    value="{{ config.get('OPENAI_API_KEY', '') }}"
                                    placeholder="sk-proj..."
                            >
                            <button
                                    type="button"
                                    onclick="toggleInputVisibility('OPENAI_API_KEY', this)"
                                    class="absolute inset-y-0 right-0 flex items-center px-2 text-slate-400 hover:text-white cursor-pointer"
                            >
                                <span class="material-icons" id="OPENAI_API_KEY_icon">visibility</span>
                            </button>
                        </div>
                    </div>

                    <label class="block mb-4">
                        <label for="OPENAI_MODEL" class="flex justify-between items-center font-semibold text-sm text-slate-300 relative">
                            OpenAI Realtime API Model
                            <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                  onclick="toggleTooltip(this)">
                                help_outline
                            </span>
                        </label>
                        <div class="relative">
                            <div data-tooltip>
                                Choose between the two realtime models that are currently available:<br>
                                <strong>gpt-4o-mini-realtime-preview</strong> is cheaper and the default.<br>
                                <strong>gpt-realtime</strong> is higher performance but also more expensive in token usage (~ √ó6.66 compared to mini).
                                <br><br>
                                <strong>gpt-realtime-mini</strong> same cost as the mini preview.<br>
                                <strong>gpt-4o-realtime-preview</strong> is deprecated (and most expensive).<br><br>
                                See <a href="https://openai.com/api/pricing/" target="_blank" class="underline hover:text-cyan-400">OpenAI Realtime API Pricing</a> for details .
                            </div>

                            <select id="OPENAI_MODEL" name="OPENAI_MODEL"
                                    class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                <option value="gpt-4o-mini-realtime-preview"
                                        {% if config.get(
                                'OPENAI_MODEL') == 'gpt-4o-mini-realtime-preview' %}selected{% endif %}>
                                gpt-4o-mini-realtime-preview (default)
                                </option>
                                <option value="gpt-realtime"
                                        {% if config.get(
                                'OPENAI_MODEL') == 'gpt-realtime' %}selected{% endif %}>
                                gpt-realtime (better but more expensive)
                                </option>
                                <option value="gpt-realtime-mini"
                                        {% if config.get(
                                'OPENAI_MODEL') == 'gpt-realtime-mini' %}selected{% endif %}>
                                gpt-realtime-mini
                                </option>
                                <option value="gpt-4o-realtime-preview" disabled
                                        {% if config.get(
                                'OPENAI_MODEL') == 'gpt-4o-realtime-preview' %}selected{% endif %}>
                                gpt-4o-realtime-preview (deprecated)
                                </option>
                            </select>
                        </div>
                    </label>

                    <div class="flex gap-2">
                        <div class="mb-4 grow flex flex-col justify-between">
                            <label for="hostname" class="block font-semibold text-sm text-slate-300">Device
                                Hostname</label>
                            <div class="flex items-center mt-1 gap-2">
                                <input
                                        id="hostname"
                                        name="hostname"
                                        type="text"
                                        data-original=""
                                        data-default="raspberrypi"
                                        class="w-full p-3  bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        value=""
                                >
                                <span>.local:</span>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="FLASK_PORT" class="block font-semibold text-sm text-slate-300">Web UI
                                Port</label>
                            <input
                                    id="FLASK_PORT"
                                    name="FLASK_PORT"
                                    type="number"
                                    min="1"
                                    max="65535"
                                    data-default="80"
                                    class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    value="{{ config.get('FLASK_PORT', '80') }}"
                            >
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="RUN_MODE"
                               class="flex justify-between items-center font-semibold text-sm text-slate-300 relative">
                            Mode
                            <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                  onclick="toggleTooltip(this)">help_outline</span>
                        </label>

                        <div class="relative">
                            <div data-tooltip>
                                After pressing the red button, Billy: </br>
                                <b>Normal:</b> tries to keep the conversation going until the mic silence timeout is
                                reached (see Audio Settings).<br>
                                <b>Dory:</b> responds only once, then ends and forgets the conversation.
                            </div>
                            <select id="RUN_MODE" name="RUN_MODE"
                                    class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                <option value="normal" {% if config.get(
                                'RUN_MODE', 'normal') == 'normal' %}selected{% endif %}>Normal</option>
                                <option value="dory" {% if config.get(
                                'RUN_MODE') == 'dory' %}selected{% endif %}>Dory</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4 relative">
                        <label for="VOICE" class="block font-semibold text-sm text-slate-300">Voice
                        </label>
                        <select id="VOICE" name="VOICE"
                                class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            {% for v in config.get('VOICE_OPTIONS',[]) %}
                            <option value="{{ v }}" {% if config.get(
                            'VOICE') == v %}selected{% endif %}>
                            {{ v|capitalize }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="TURN_EAGERNESS"
                               class="flex justify-between items-center font-semibold text-sm text-slate-300 relative">
                            Turn Detection Eagerness
                            <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                  onclick="toggleTooltip(this)">help_outline</span>
                        </label>

                        <div class="relative">
                            <div data-tooltip>
                                How quickly Billy should respond to you. If Billy cuts in too often, set low. If he feels sluggish, set high. <br/>
                                <b>Low</b> = patient (waits longer)<br/>
                                <b>Medium</b> = balanced<br/>
                                <b>High</b> = snappy (may interrupt sooner)
                            </div>

                            <select id="TURN_EAGERNESS" name="TURN_EAGERNESS"
                                    class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                <option value="low" {% if config.get('TURN_EAGERNESS', 'medium') == 'low' %}selected{% endif %}>Low (patient)</option>
                                <option value="medium" {% if config.get('TURN_EAGERNESS', 'medium') == 'medium' %}selected{% endif %}>Medium (balanced)</option>
                                <option value="high" {% if config.get('TURN_EAGERNESS', 'medium') == 'high' %}selected{% endif %}>High (snappy)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Hardware Settings -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-hardware">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Hardware Settings
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>

                    <div class="mb-4 relative">
                        <label for="BILLY_PINS_SELECT"
                               class="flex justify-between items-center font-semibold text-sm text-slate-300">
                            Pin Layout
                            <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                  onclick="toggleTooltip(this)">help_outline</span>
                        </label>

                        <!-- Tooltip -->
                        <div class="relative">
                            <div data-tooltip>
                                Choose which GPIO pin layout your unit is wired for.
                                <b>New</b> is the default (quieter pins, mouth single-direction).
                                Select <b>Legacy</b> only for older wiring.
                                Changing this restarts Billy immediately.
                            </div>

                            <select id="BILLY_PINS_SELECT" name="BILLY_PINS"
                                    class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                                <option value="new">New (default)</option>
                                <option value="legacy">Legacy (old wiring)</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4" id="hardware-version-row">
                        <label for="BILLY_MODEL" class="block font-semibold text-sm text-slate-300">
                            Billy Version
                        </label>
                        <select id="BILLY_MODEL" name="BILLY_MODEL"
                                class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            <option value="modern" {% if config.get(
                            'BILLY_MODEL', 'modern') == 'modern' %}selected{% endif %}>
                            Modern (2 motors)
                            </option>
                            <option value="classic" {% if config.get(
                            'BILLY_MODEL') == 'classic' %}selected{% endif %}>
                            Classic (3 motors)
                            </option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="RUN_MODE"
                               class="flex justify-between items-center font-semibold text-sm text-slate-300 relative">
                            Motor test
                            <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                  onclick="toggleTooltip(this)">help_outline</span>
                        </label>

                        <div class="relative">
                            <div data-tooltip>
                                Use these buttons to test the motors individually.<br>
                                Each button will activate the corresponding motor for ~1 second.  Restart Billy when completed.
                        </div>
                            <div class="flex flex-wrap mt-1 gap-4">
                                <button type="button" id="test-mouth-btn"
                                        class="motor-test-btn bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded">
                                    Mouth
                                </button>
                                <button type="button" id="test-head-btn"
                                        class="motor-test-btn bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded">
                                    Head
                                </button>
                                <button type="button" id="test-tail-btn"
                                        class="motor-test-btn bg-zinc-800 hover:bg-zinc-700 px-4 py-2 rounded">
                                    Tail
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Audio -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-audio">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Audio Settings
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>

                    <div class="flex items-center gap-2 mb-4">
                        <span class="material-icons">settings_voice</span>
                        <span id="mic-label" class="grow">Loading...</span>
                    </div>

                    <div class="flex mb-4 gap-4">
                        <div class="flex-1/2 flex flex-col justify-between">
                            <label for="MIC_TIMEOUT_SECONDS" class="flex justify-between items-center font-semibold text-sm text-slate-300">
                                Mic Timeout (s)
                                <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                      onclick="toggleTooltip(this)">
                                   help_outline
                                </span>
                            </label>
                            <div class="relative">
                                <div data-tooltip>
                                    How many seconds of silence Billy should wait before he ends the conversation.<br/>
                                    Lower = ends quicker, higher = more forgiving.
                                </div>
                                <input type="number"
                                       class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                       name="MIC_TIMEOUT_SECONDS" id="MIC_TIMEOUT_SECONDS"
                                       value="{{ config.get('MIC_TIMEOUT_SECONDS', '6') }}">
                            </div>
                        </div>

                        <div class="flex-1/2 flex flex-col justify-between">
                            <label for="SILENCE_THRESHOLD" class="block font-semibold text-sm text-slate-300">Silence
                                Threshold (RMS)
                            </label>
                            <input type="number" step="1" id="SILENCE_THRESHOLD"
                                   class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                   name="SILENCE_THRESHOLD" value="{{ config.get('SILENCE_THRESHOLD', '1') }}">
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="flex items-center justify-between font-semibold text-sm text-slate-300 mb-1">
                            Microphone level & Silence Threshold
                            <span class="material-icons align-middle hover:text-cyan-400 cursor-pointer ml-1"
                                  onclick="toggleTooltip(this)">
                                help_outline
                            </span>
                        </label>

                        <div class="flex gap-2 mb-4 relative">
                            <div data-tooltip>
                                Click ‚ÄúTest‚Äù to start a live microphone level preview.<br/>
                                You can drag the red line to adjust the <b>silence threshold</b>.<br/>
                                Billy will only consider audio as "speaking" when the bar crosses this threshold. <br/>
                                Adjust the <b>silence threshold</b> and/or <b>gain</b> so that in your normal environment,
                                the volume bar stays below the red line while idle (background noise) but
                                jumps above it when you speak. Restart Billy after completion.
                            </div>

                            <!-- Mic level bar container -->
                            <div id="mic-bar-container"
                                 class="relative mt-2 h-4 w-full rounded-full bg-zinc-700 overflow-hidden">
                                <!-- Fill bar -->
                                <div id="mic-level-bar"
                                     class="absolute left-0 top-0 h-full w-0 bg-emerald-500 transition-all duration-100"
                                ></div>

                                <!-- Threshold line -->
                                <div id="threshold-line"
                                     class="absolute top-0 bottom-0 w-[2px] bg-red-500 cursor-ew-resize"
                                     style="left: 10%;"
                                     draggable="false">
                                </div>
                            </div>

                            <button type="button" id="mic-check-btn"
                                    class="bg-zinc-800 hover:bg-zinc-700 text-white text-sm items-center px-2 py-1 rounded shadow w-20 flex gap-1.5 cursor-pointer">
                                <span class="material-icons align-middle">mic</span>
                                Test
                            </button>
                        </div>

                        <!-- Mic Gain Slider -->
                        <div class="mb-8 flex gap-2 items-center">
                            <div class="w-20 text-sm font-medium text-gray-200">
                                Gain: <span id="mic-gain-value">8</span>
                            </div>
                            <input type="range" id="mic-gain" min="0" max="16" step="1" value="8" class="hidden">
                            <div
                                    class="relative w-full rounded-full bg-zinc-700 overflow-hidden cursor-pointer h-4"
                                    id="mic-gain-bar"
                                    style="user-select: none;"
                            >
                                <div
                                        class="absolute left-0 top-0 h-full bg-emerald-500 transition-all duration-100"
                                        id="mic-gain-fill"
                                        style="width: 50%;"
                                        data-value="8"
                                ></div>
                            </div>
                        </div>
                    </div>


                    <div class="flex items-center gap-2 mb-4">
                        <span class="material-icons">speaker</span>
                        <span id="speaker-label" class="grow">Loading...</span>
                    </div>

                    <!-- Speaker Volume Slider -->
                    <div class="mb-4">
                        <label for="speaker-volume" class="block font-semibold text-sm text-slate-300 mb-1">
                            Speaker Volume
                        </label>
                        <div class="flex gap-2 items-center">
                            <input type="range" id="speaker-volume" min="0" max="100" value="50"
                                   class="hidden">
                            <div
                                    class="relative w-full rounded-full bg-zinc-700 overflow-hidden cursor-pointer h-4"
                                    id="speaker-volume-bar"
                                    style="user-select: none;"
                            >
                                <div
                                        class="absolute left-0 top-0 h-full bg-emerald-500 transition-all duration-100"
                                        id="speaker-volume-fill"
                                        style="width: 50%;"
                                        data-value="50"
                                ></div>
                            </div>
                            <button
                                    type="button"
                                    id="speaker-check-btn"
                                    class="bg-zinc-800 hover:bg-zinc-700 text-white text-sm items-center px-2 py-1 rounded shadow w-20 flex gap-1.5 cursor-pointer"
                            >
                                <span class="material-icons align-middle">volume_up</span>
                                Test
                            </button>
                        </div>
                    </div>
                </div>

                <!-- MQTT Settings -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-mqtt">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        MQTT Settings
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>

                    <div class="mb-4">
                        <label for="MQTT_HOST" class="block font-semibold text-sm text-slate-300">MQTT Host</label>
                        <input
                                id="MQTT_HOST"
                                name="MQTT_HOST"
                                type="text"
                                class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                value="{{ config.get('MQTT_HOST', '') }}"
                        >
                    </div>

                    <div class="flex flex-wrap mb-4 gap-4">
                        <div class="w-full md:w-[calc(50%-0.5rem)]">
                            <label for="MQTT_USERNAME" class="block font-semibold text-sm text-slate-300">MQTT
                                Username</label>
                            <input
                                    id="MQTT_USERNAME"
                                    name="MQTT_USERNAME"
                                    type="text"
                                    class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    value="{{ config.get('MQTT_USERNAME', '') }}"
                            >
                        </div>
                        <div class="w-full md:w-[calc(50%-0.5rem)]">
                            <label for="MQTT_PASSWORD" class="block font-semibold text-sm text-slate-300">MQTT
                                Password</label>
                            <div class="relative">
                                <input
                                        id="MQTT_PASSWORD"
                                        name="MQTT_PASSWORD"
                                        type="password"
                                        class="w-full p-3 mt-1  bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                        value="{{ config.get('MQTT_PASSWORD', '') }}"
                                >
                                <button
                                        type="button"
                                        onclick="toggleInputVisibility('MQTT_PASSWORD', this)"
                                        class="absolute inset-y-0 right-0 flex items-center px-2 text-slate-400 hover:text-white cursor-pointer"
                                >
                                    <span class="material-icons" id="MQTT_PASSWORD_icon">visibility</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Home Assistant -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-ha">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Home Assistant
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>
                    <div class="mb-4">
                        <label for="HA_HOST" class="block font-semibold text-sm text-slate-300">Home Assistant
                            Host</label>
                        <input
                                id="HA_HOST"
                                name="HA_HOST"
                                type="text"
                                class="w-full p-3 mt-1 pr-10 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                value="{{ config.get('HA_HOST', '') }}"
                        >
                    </div>

                    <div class="mb-4">
                        <label for="HA_TOKEN" class="block font-semibold text-sm text-slate-300">Home Assistant
                            Token</label>
                        <div class="relative">
                            <input
                                    id="HA_TOKEN"
                                    name="HA_TOKEN"
                                    type="password"
                                    class="w-full p-3 mt-1 pr-10 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                    value="{{ config.get('HA_TOKEN', '') }}"
                            >
                            <button
                                    type="button"
                                    onclick="toggleInputVisibility('HA_TOKEN', this)"
                                    class="absolute inset-y-0 right-0 flex items-center px-2 text-slate-400 hover:text-white cursor-pointer"
                            >
                                <span class="material-icons" id="HA_TOKEN_icon">visibility</span>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="HA_LANG" class="block font-semibold text-sm text-slate-300 mb-1">Language
                        </label>
                        {% set ha_languages = [
                        ('en', 'English'), ('nl', 'Dutch'), ('it', 'Italian'), ('fr', 'French'),
                        ('de', 'German'), ('es', 'Spanish'), ('pt', 'Portuguese'), ('hi', 'Hindi'),
                        ('ja', 'Japanese'), ('zh', 'Chinese'), ('ko', 'Korean'), ('ru', 'Russian'),
                        ('pl', 'Polish'), ('cs', 'Czech'), ('tr', 'Turkish'), ('ro', 'Romanian'),
                        ('uk', 'Ukrainian'), ('vi', 'Vietnamese'), ('ar', 'Arabic'), ('id', 'Indonesian')
                        ] %}
                        <select name="HA_LANG" id="HA_LANG"
                                class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500">
                            {% for code, label in ha_languages %}
                            <option value="{{ code }}" {% if config.get(
                            'HA_LANG') == code %}selected{% endif %}>
                            {{ label }} ({{ code }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </form>

            <div class="sticky bottom-0 z-10 p-4">
                <div class="flex justify-center">
                    <div class="relative inline-block">
                        <!-- Split button -->
                        <div class="flex rounded shadow overflow-hidden border border-emerald-500">
                            <button
                                    id="save-btn"
                                    class="bg-emerald-500 hover:bg-emerald-400 text-zinc-800 font-semibold py-2 px-4 flex items-center gap-1 focus:outline-none"
                                    type="submit"
                                    form="config-form"
                            >
                                <span class="material-icons align-middle">save</span>
                                Save Settings
                            </button>
                            <button
                                    id="dropdown-btn"
                                    type="button"
                                    class="dropdown-toggle bg-emerald-500 hover:bg-emerald-400 text-zinc-800 px-2 flex items-center"
                                    onclick="toggleDropdown(this)"
                            >
                                <span class="material-icons align-middle transition-transform duration-200">expand_more</span>
                            </button>
                        </div>
                        <!-- Dropdown -->
                        <div class="dropdown-menu absolute bottom-0 right-0 w-full text-zinc-800 border border-emerald-500  backdrop-blur-xs  rounded  z-20 hidden">
                            <button onclick="exportSettings()"
                                    class="w-full flex gap-2 items-center px-4 py-2 bg-emerald-500 hover:bg-emerald-400 cursor-pointer">
                                <span class="material-icons">file_download</span>
                                Export Settings
                            </button>
                            <label class="w-full flex gap-2 items-center px-4 py-2 bg-emerald-500/80relative bg-emerald-500 hover:bg-emerald-400 cursor-pointer">
                                <span class="material-icons">file_upload</span>
                                <span>Import Settings</span>
                                <input type="file" accept=".env" onchange="importSettings(this)" class="hidden"/>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Persona Column (consistent with Settings) -->
        <section class="space-y-4 md:space-y-6">
            <form id="persona-form" class="p-4 md:p-6">
                <!-- Persona Traits -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-persona-traits">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Persona Traits
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>
                    <div id="personality-sliders" class="space-y-4">
                        <!-- JS will populate this -->
                    </div>
                </div>

                <!-- Backstory -->

                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-backstory-instructions">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Backstory
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>
                    <div>
                        <div id="backstory-fields" class="space-y-2"></div>
                        <button type="button" onclick="addBackstoryField()"
                                class="text-sm text-emerald-500 hover:text-emerald-400 mt-2 flex items-center cursor-pointer">
                            <span class="material-icons align-middle mr-1 ">add_circle_outline</span>
                            Add Field
                        </button>
                    </div>
                </div>

                <!-- Meta Instructions -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-instructions">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Additional Instructions
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>
                    <div>
                        <textarea name="META" id="meta-text" rows="16"
                                  class="w-full p-3 mt-1 bg-zinc-800 text-white rounded focus:outline-none focus:ring-2 focus:ring-cyan-500"
                                  spellcheck="false"></textarea>
                    </div>
                </div>

                <!-- Wake-up Sounds -->
                <div class="bg-zinc-900/50 backdrop-blur-xs border border-zinc-700 p-4 md:p-6 rounded-lg shadow-sm mb-6 collapsible-section"
                     id="section-wakeup-sounds">
                    <h3 class="flex items-center gap-2 cursor-pointer group text-lg grow justify-between font-bold mb-4 text-slate-200">
                        Wake-up Sounds
                        <span class="material-icons transition-transform duration-200 ml-2 rotate-0">expand_more</span>
                    </h3>

                    <div id="wakeup-sound-list" class="space-y-2">

                    </div>

                    <button type="button" onclick="addWakeupSound()"
                            class="text-sm text-emerald-500 hover:text-emerald-400 mt-2 flex items-center cursor-pointer">
                        <span class="material-icons align-middle mr-1">add_circle_outline</span>
                        Add Wake-up Sound
                    </button>
                </div>

            </form>

            <div class="sticky bottom-0 z-10 p-4">
                <div class="flex justify-center">
                    <div class="relative inline-block">
                        <!-- Split button -->
                        <div class="flex rounded shadow overflow-hidden border border-emerald-500">
                            <button
                                    id="save-persona-btn"
                                    class="bg-emerald-500 hover:bg-emerald-400 text-zinc-800 font-semibold py-2 px-4 flex items-center gap-1 focus:outline-none"
                                    type="submit"
                                    form="persona-form"
                            >
                                <span class="material-icons align-middle">person</span>
                                Save Persona
                            </button>
                            <button
                                    id="persona-dropdown-btn"
                                    type="button"
                                    class="dropdown-toggle bg-emerald-500 hover:bg-emerald-400 text-zinc-800 px-2 flex items-center"
                                    onclick="toggleDropdown(this)"
                            >
                                <span class="material-icons align-middle transition-transform duration-200">expand_more</span>
                            </button>
                        </div>
                        <!-- Dropdown -->
                        <div
                                class="dropdown-menu absolute bottom-0  right-0 w-full text-zinc-800 border border-emerald-500 rounded z-20 hidden"
                        >
                            <button onclick="exportPersona()"
                                    class="w-full flex gap-2 items-center px-4 py-2 bg-emerald-500 hover:bg-emerald-400 cursor-pointer">
                                <span class="material-icons">file_download</span>
                                Export Persona
                            </button>
                            <label class="w-full flex gap-2 items-center px-4 py-2 bg-emerald-500 hover:bg-emerald-400 cursor-pointer">
                                <span class="material-icons">file_upload</span>
                                <span>Import Persona</span>
                                <input type="file" accept=".ini" onchange="importPersona(this)" class="hidden"/>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </div>
</main>

<footer class="backdrop-blur-xs fixed bottom-0 p-4 left-0 w-full h-20 shadow-[0_-6px_12px_rgba(0,0,0,0.2)]">

</footer>
<script src="{{ url_for('static', filename='js/config.js') }}"></script>
<script src="{{ url_for('static', filename='js/marked-min.js') }}"></script>
</body>
</html>
